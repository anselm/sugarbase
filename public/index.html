<!DOCTYPE html>
<html lang="en">
<head>

<title>SugarBase</title>

<link rel="icon" href="/art/favicon.ico">

<!-- some browsers will paint emoji badly sometimes unless they get primed for some reason -->
<meta name="ðŸ”’ðŸ”’ðŸ”’" content="this is a hint to tell the browser that there will be emoji">

<!-- It's nice to use a Web Monetization Payment Pointer - use your own unless you want to pay me - see coil.com -->
<meta name="monetization" content="$coil.xrptipbot.com/5ra3zZ_aRIS8CUUFzZcHcQ">

<!-- Disable scaling on mobile displays -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

<!-- Web Application Manifest - see https://developer.mozilla.org/en-US/docs/Web/Manifest -->
<link rel="manifest" type="application/json" href="manifest.json">

<!-- Register .webmanifest as a type for android desktop -->
<staticContent>
<mimeMap fileExtension=".json" mimeType="application/json" />
<mimeMap fileExtension=".webmanifest" mimeType="application/manifest+json" />
</staticContent>

<!-- Allow add to homescreen as a pseudo PWA app for ios -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="SugarBase">
<meta name="theme-color" content="#4285F4">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Sugar">
<meta name="apple-mobile-web-app-status-bar-style" content="#4285F4">

<!-- a built in style -->
<link type="text/css" rel="stylesheet" href="/sugarbase/style/sugar-mobile.css" >

</head>
<body>
</body>
</html>

<script type=module>

// useful layout

import '/sugarbase/elements/sugar-element.js'
import '/sugarbase/elements/sugar-404-page.js'
import '/sugarbase/elements/crud/sugar-collection.js'
import '/sugarbase/elements/crud/sugar-sigil.js'
import '/sugarbase/elements/crud/sugar-card.js'
import '/sugarbase/elements/crud/sugar-form.js'
import '/sugarbase/elements/auth/sugar-login-page.js'
import '/sugarbase/elements/auth/sugar-profile-page.js'
import '/sugarbase/elements/auth/sugar-signup-page.js'
import '/sugarbase/elements/auth/sugar-signout-page.js'
import {router} from '/sugarbase/elements/sugar-router.js'

// app specific layout

import {NavBarElement} from '/fancy-site/nav-bar-element.js'
import '/fancy-site/splash-page.js'

//import './menu-page.js'
//import './groups.js'

// make these useful services globally available to my code

import {db} from '/sugarbase/services/ramdb.js'
import {state} from '/sugarbase/services/state.js'

window.Services = {
	db:db,
	state:state,
	useFirebase:0.
}

async function run() {

	// use firebase or not?

	if(Services.useFirebase) {
		await import('./party-login-firebase-page.js')
		let {db} = await import('/sugarbase/services/firebase.js')
	} else {
		let {somedata} = await import('/sugarbase/services/somedata.js')
		somedata(db)		
	}

	// handle zero length route

	router.unshift( (segments) => {
		if(!segments || segments.length < 1 || segments[0].length==0) {
			return { element:"splash-page", state:state }
		}
		return 0
	})

	// handle auth route with supplied props also

	router.push( (segments) => {
		console.log(segments)
		if(!segments || segments.length < 1 || segments[0].length==0) return 0
		switch(segments[0]) {
			case "login":
				if(state.currentParty) {
					// hack - if we land here with a user - send them to home page - can i send an empty page? in the mean time?
					window.history.pushState({},"/","/")
					return { element:"splash-page", state:state }
				}
				return {element:"sugar-login-page",login:db.login.bind(db)}
			case "signup":
				return {element:"sugar-signup-page",signup:db.signup.bind(db)}
			case "signout":
				return {element:"sugar-signout-page",signout:db.signout.bind(db)}
		}
		return 0
	})

/*
	// handle groups...
	// handle events...
	// handle menu page
	// handle app specific details

	router.push( (segments) => {

		case "profile": return "profile-page"


		case "event": return "event-detail-page"
		case "events":
			if(segments.length>1 && segments[1]=="edit") return "event-edit-page"
			return "events-page"
		case "group": return "group-detail-page"
		case "groups":
			if(segments.length>1 && segments[1]=="edit") return "event-edit-page"
			return "groups-page"
		case "menu": return "menu-page"
		default: break
	}
*/

	// 404

	router.push( ()=> { return "sugar-404-page" })

	// force insert nav bar once

	document.body.appendChild( new NavBarElement() )

	// i prefer to refresh the current page after an auth event so that pages do not have to watch for auth transitions

	db.onauth( (user)=> {
		Services.state.set({currentParty:user})
		router.reset()
	})

	// fake an auth event if not using a real datastore

	if(!Services.useFirebase) db.authchange(0)

}

document.addEventListener('DOMContentLoaded', run )


</script>
